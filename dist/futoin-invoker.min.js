!function(a){"function"==typeof define&&define.amd?define(["futoin-asyncsteps","lodash"],a):"object"==typeof exports?module.exports=a(require("futoin-asyncsteps"),require("lodash")):this.FutoInInvoker=a($as,_)}(function(a,b){function c(a){var b=c.cache[a];if(!b){var d={};b=c.cache[a]={id:a,exports:d},c.modules[a].call(d,b,d)}return b.exports}var d=this;return c.cache=[],c.modules=[function(a,b){"use strict";function d(a){a=a||{};var b=a[h.OPT_SPEC_DIRS]||[];b instanceof Array||(b=[b]),a[h.OPT_SPEC_DIRS]=b,i.SimpleCCMImpl.call(this,a)}var e,f=c(3),g=f.FutoInError,h=f.Options,i=c(6),j=c(7),k=c(9);if(j){var l=require;e=l("fs")}b=a.exports=function(b){return new a.exports.AdvancedCCMImpl(b)};var m={standard_errors:{UnknownInterface:!0,NotSupportedVersion:!0,NotImplemented:!0,Unauthorized:!0,InternalError:!0,InvalidRequest:!0,DefenseRejected:!0,PleaseReauth:!0,SecurityError:!0},loadSpec:function(a,b,c){for(var d,h=null,i=b.iface+"-"+b.version+"-iface.json",j=0;j<c.length;++j){if(d=c[j],"string"==typeof d){if(d=d+"/"+i,!e||!e.existsSync(d))continue;d=e.readFileSync(d,{encoding:"utf8"}),d=JSON.parse(d)}if("object"==typeof d&&d.iface===b.iface&&d.version===b.version&&"funcs"in d){h=d;break}}null===h&&a.error(g.InternalError,"Failed to load valid spec for "+b.iface+":"+b.version),b.funcs=k.cloneDeep(h.funcs);var l,n;for(var o in b.funcs){if(l=b.funcs[o],l.min_args=0,"params"in l){var p=l.params;"object"!=typeof p&&a.error(g.InternalError,"Invalid params object");for(n in p){var q=p[n];"object"!=typeof q&&a.error(g.InternalError,"Invalid param object"),"type"in q||a.error(g.InternalError,"Missing type for params"),"default"in q||(l.min_args+=1)}}else l.params={};if(l.expect_result=!1,"result"in l){var r=l.result;"object"!=typeof r&&a.error(g.InternalError,"Invalid result object");for(var s in r){var t=r[s];"object"!=typeof t&&a.error(g.InternalError,"Invalid resultvar object"),"type"in t||a.error(g.InternalError,"Missing type for result"),l.expect_result=!0}}else l.result={};if("rawupload"in l||(l.rawupload=!1),"rawresult"in l||(l.rawresult=!1),l.rawresult&&(l.expect_result=!0),"throws"in l){l.expect_result||a.error(g.InternalError,'"throws" without result');var u=l["throws"];Array.isArray(u)||a.error(g.InternalError,'"throws" is not array'),l["throws"]=k.object(u,u)}else l["throws"]={}}if("requires"in h){var v=h.requires;Array.isArray(v)||a.error(g.InternalError,'"requires" is not array'),b.constraints=k.object(v,v)}else b.constraints={};if(b.inherits=[],"inherit"in h){var w={},x=h.inherit.match(f._ifacever_pattern);null===x&&a.error(g.InvokerError,"Invalid inherit ifacever: "+h.inherit),w.iface=x[1],w.version=x[4],m.loadSpec(a,w,c);for(o in w.funcs){var y=w.funcs[o];if(o in b.funcs){var z=y.params,A=b.funcs[o].params,B=Object.keys(z),C=Object.keys(A);for(C.length<B.length&&a.error(g.InternalError,"Invalid param count for '"+o+"'"),j=0;j<B.length;++j)n=B[j],n!==C[j]&&a.error(g.InternalError,"Invalid param order for '"+o+"/"+n+"'"),z[n].type!==A[n].type&&a.error(g.InternalError,"Param type mismatch '"+o+"/"+n+"'");for(;j<C.length;++j)n=C[j],n in z||"default"in A[n]||null===A[n]||a.error(g.InternalError,"Missing default for '"+o+"/"+n+"'");y.rawresult!==b.funcs[o].rawresult&&a.error(g.InternalError,"'rawresult' flag mismatch for '"+o+"'"),y.rawupload&&!b.funcs[o].rawupload&&a.error(g.InternalError,"'rawupload' flag is missing for '"+o+"'")}else b.funcs[o]=y}b.inherits.push(h.inherit),b.inherits=b.inherits.concat(w.inherits),k.difference(Object.keys(w.constraints),h.requires).length&&a.error(g.InternalError,"Missing constraints from inherited")}},checkFutoInType:function(a,b,c,d){var e="";switch(b){case"boolean":case"string":e=b;break;case"map":e="object";break;case"number":e="number";break;case"integer":return void(("number"!=typeof d||(0|d)!==d)&&a.error(g.InvalidRequest,"Type mismatch for parameter: "+c));case"array":return void(d instanceof Array||a.error(g.InvalidRequest,"Type mismatch for parameter: "+c))}typeof d!==e&&a.error(g.InvalidRequest,"Type mismatch for parameter: "+c)}};b.SpecTools=m,d.prototype={onRegister:function(a,b){m.loadSpec(a,b,this.options[h.OPT_SPEC_DIRS])},checkParams:function(a,b,c){var d,e=b.info,f=b.name;"SecureChannel"in e.constraints&&!e.secure_channel&&a.error(g.SecurityError,"Requires secure channel"),"AllowAnonymous"in e.constraints||e.creds||a.error(g.SecurityError,"Requires authenticated user"),f in e.funcs||a.error(g.InvokerError,"Unknown interface function");var h=e.funcs[f];b.upload_data&&!h.rawupload&&a.error(g.InvokerError,"Raw upload is not allowed"),!Object.keys(h.params).length&&Object.keys(c).length&&a.error(g.InvokerError,"No params are defined");for(d in c)h.params.hasOwnProperty(d)||a.error(g.InvokerError,"Unknown parameter "+d),m.checkFutoInType(a,h.params[d].type,d,c[d]);for(d in h.params)c.hasOwnProperty(d)||h.params[d].hasOwnProperty("default")||a.error(g.InvokerError,"Missing parameter "+d)},createMessage:function(a,b,c){this.options[h.OPT_PROD_MODE]||this.checkParams(a,b,c);var d=b.info,e={f:d.iface+":"+d.version+":"+b.name,p:c};null!==d.creds&&("master"===d.creds||(e.sec=d.creds)),b.expect_response=d.funcs[b.name].expect_result,a.success(e)},onMessageResponse:function(a,b,c){var d=b.info,e=d.funcs[b.name];if("e"in c){var f=c.e;f in e["throws"]||f in m.standard_errors?a.error(f,c.edesc):a.error(g.InternalError,"Not expected exception from Executor")}e.rawresult&&a.error(g.InternalError,"Raw result is expected"),"master"===d.creds;var h=e.result,i=Object.keys(h).length;for(var j in c.r)h.hasOwnProperty(j)&&(m.checkFutoInType(a,h[j].type,j,c.r[j]),--i);i>0&&a.error(g.InternalError,"Missing result variables"),a.success(c.r)},onDataResponse:function(a,b,c){b.info.funcs[b.name].rawresult?a.success(c):a.error(g.InternalError,"Raw result is not expected")},perfomHTTP:i.SimpleCCMImpl.prototype.perfomHTTP,perfomWebSocket:i.SimpleCCMImpl.prototype.perfomWebSocket,perfomUNIX:i.SimpleCCMImpl.prototype.perfomUNIX},b.AdvancedCCMImpl=d},function(a){!function(b){"use strict";var d=b.FutoIn||{};if("undefined"==typeof d.Invoker){var e=c(4),f=e.SimpleCCM;b.SimpleCCM=f;var g=e.AdvancedCCM;b.AdvancedCCM=g,d.Invoker=e,b.FutoIn=d,a&&(a.exports=e)}}(window)},function(a,b){"use strict";b.HTTPComms=function(){},b.HTTPComms.prototype={perform:function(){}},b.WSComms=function(){},b.WSComms.prototype={perform:function(){}}},function(a,b){"use strict";var d=c(8);b.AsyncSteps=d,b.FutoInError=d.FutoInError,b.Options={OPT_CALL_TIMEOUT_MS:"CALL_TIMEOUT_MS",OPT_X509_VERIFY:"X509_VERIFY",OPT_PROD_MODE:"PROD_MODE",OPT_COMM_CONFIG_CB:"COMM_CONFIG_CB",OPT_SPEC_DIRS:"SPEC_DIRS"},b._ifacever_pattern=/^(([a-z][a-z0-9]*)(\.[a-z][a-z0-9]*)*):(([0-9]+)\.([0-9]+))$/},function(a,b){"use strict";function d(a){this._iface_info={},this._iface_impl={},this._impl=j(a)}function e(a){this._iface_info={},this._iface_impl={},this._impl=k(a)}var f=c(3),g=f.FutoInError,h=c(5),i=c(9),j=c(6),k=c(0),l={SVC_RESOLVER:"#resolver",SVC_AUTH:"#auth",SVC_DEFENSE:"#defense",SVC_ACL:"#acl",SVC_LOG:"#log",SVC_CACHE_L1:"#cachel1",SVC_CACHE_L2:"#cachel2",SVC_CACHE_L3:"#cachel3"};i.extend(l,f.Options),i.extend(d,l);var m={SVC_RESOLVER:"#resolver",SVC_AUTH:"#auth",SVC_DEFENSE:"#defense",SVC_ACL:"#acl",SVC_LOG:"#log",SVC_CACHE_L1:"#cachel1",SVC_CACHE_L2:"#cachel2",SVC_CACHE_L3:"#cachel3",_secure_replace:/^secure\+/,_secure_test:/^(https|wss|unix):\/\//,_native_iface_builder:function(a,b){return h(a,b)}};i.extend(m,l),m.register=function(a,b,c,d,e,h){b in this._iface_info&&a.error(g.InvokerError,"Already registered");var j=c.match(f._ifacever_pattern);null===j&&a.error(g.InvokerError,"Invalid ifacever");var k=j[1],l=j[4],m=j[5],n=j[6],o=!1,p=null;"string"==typeof d?(this._secure_replace.test(d)?(o=!0,d=d.replace(this._secure_replace,"")):this._secure_test.test(d)&&(o=!0),p=this._native_iface_builder):(p=d,d=null),h=h||{},i.defaults(h,this._impl.options);var q={iface:k,version:l,mjrver:m,mnrver:n,endpoint:d,creds:e||null,secure_channel:o,impl:p,regname:b,inherits:null,funcs:null,constraints:null,options:h};this._iface_info[b]=q,this._impl.onRegister(a,q)},m.iface=function(a){var b=this._iface_info[a];if(!b)throw new Error(g.InvokerError);var c=b.regname,d=this._iface_impl[c];return d||(d=b.impl(this._impl,b),this._iface_impl[c]=d),d},m.unRegister=function(a){var b=this._iface_info[a];if(!b)throw new Error(g.InvokerError);var c=b.regname;if(c===a){if(delete this._iface_info[c],delete this._iface_impl[c],b.aliases)for(var d=b.aliases,e=0;e<d.length;++e)delete this._iface_info[d[e]]}else delete this._iface_info[a],b.aliases.splice(b.aliases.indexOf(a),0)},m.defense=function(){return this.iface(this.SVC_DEFENSE)},m.log=function(){return this.iface(this.SVC_LOG)},m.burst=function(){throw new Error(g.NotImplemented)},m.cache_l1=function(){return this.iface(this.SVC_CACHE_L1)},m.cache_l2=function(){return this.iface(this.SVC_CACHE_L2)},m.cache_l3=function(){return this.iface(this.SVC_CACHE_L3)},m.assertIface=function(a,b){var c=this._iface_info[a];if(!c)throw new Error(g.InvokerError);var d=b.match(f._ifacever_pattern);if(null===d)throw new Error(g.InvokerError);var e=d[1],h=d[5],i=d[6];if(c.iface!==e||c.mjrver!==h||c.mnrver<i)throw new Error(g.InvokerError)},m.alias=function(a,b){var c=this._iface_info[a];if(!c||this._iface_info[b])throw new Error(g.InvokerError);this._iface_info[b]=c,c.aliases?c.aliases.push(b):c.aliases=[b]},d.prototype=m,i.extend(e,l);var n={};i.extend(n,m),n.initFromCache=function(a,b){a.error(g.NotImplemented,"Caching is not supported yet")},n.cacheInit=function(a){},e.prototype=n,b.SimpleCCM=d,b.AdvancedCCM=e,b.FutoInError=g,b.NativeIface=h.NativeIface,b.InterfaceInfo=h.InterfaceInfo,b.SpecTools=k.SpecTools,b.SpecTools._ifacever_pattern=f._ifacever_pattern},function(a,b){"use strict";function d(a){this._raw_info=a}function e(a,b){this._ccmimpl=a,this._raw_info=b,this._iface_info=null;for(var c in this._raw_info.funcs){var d=this._raw_info.funcs[c];d.rawupload||c in this||(this[c]=this._member_call_generate(c,d))}}var f=c(4),g=c(9);b=a.exports=function(b,c){return new a.exports.NativeIface(b,c)},d.prototype={name:function(){return this._raw_info.iface},version:function(){return this._raw_info.version},inherits:function(){return this._raw_info.inherits},funcs:function(){return this._raw_info.funcs},constraints:function(){return this._raw_info.constraints}},b.InterfaceInfo=d,e.prototype={call:function(a,b,c,d,e,g){c=c||{};var h={ccmimpl:this._ccmimpl,name:b,info:this._raw_info,upload_data:d,download_stream:e,rsp_content_type:null,native_iface:this,options:this._raw_info.options,endpoint:this._raw_info.endpoint,expect_response:!0},i=this._ccmimpl;a.add(function(a){i.createMessage(a,h,c)}),a.add(function(a,c){"number"!=typeof g&&(g=h.info.options[f.SimpleCCM.OPT_CALL_TIMEOUT_MS]),g>0&&a.setTimeout(g);var d=h.endpoint.split(":")[0];if("http"===d||"https"===d)i.perfomHTTP(a,h,c);else if("ws"===d||"wss"===d){var e;h.upload_data||h.download_stream||h.info.funcs&&(e=h.info.funcs[b])&&e.rawresult?(h.endpoint=h.endpoint.replace("ws","http"),i.perfomHTTP(a,h,c)):i.perfomWebSocket(a,h,c)}else h.upload_data?a.error(f.FutoInError.InvokerError,"Upload data is allowed only for HTTP/WS endpoints"):h.download_stream?a.error(f.FutoInError.InvokerError,"Download stream is allowed only for HTTP/WS endpoints"):"unix"===d?i.perfomUNIX(a,h,c):a.error(f.FutoInError.InvokerError,"Unknown endpoint schema");a.add(function(a,b,c){if(h.expect_response)if(h.download_stream)a.success(!0);else if("application/futoin+json"===c){if("string"==typeof b)try{b=JSON.parse(b)}catch(d){a.error(f.FutoInError.CommError,"JSON:"+d.message)}i.onMessageResponse(a,h,b)}else i.onDataResponse(a,h,b);else a.success()})})},_member_call_intercept:function(a,b,c,d){var e=c.params,h=Object.keys(e);d.length>h.length?a.error(f.FutoInError.InvokerError,"Unknown parameters"):d.length<c.min_args?a.error(f.FutoInError.InvokerError,"Missing parameters"):d.length<h.length&&(h=h.splice(0,d.length));var i=g.object(h,d);this.call(a,b,i)},_member_call_generate:function(a,b){return function(c){this._member_call_intercept(c,a,b,Array.prototype.slice.call(arguments,1))}},ifaceInfo:function(){return this._iface_info||(this._iface_info=new d(this._raw_info)),this._iface_info},burst:function(){throw new Error(f.FutoInError.InvokerError,"Not Implemented")},bindDerivedKey:function(){throw new Error(f.FutoInError.InvokerError,"Not Implemented")}},b.NativeIface=e},function(a,b){"use strict";function d(a){a=a||{};var b={};b[h.OPT_CALL_TIMEOUT]=3e4,b[h.OPT_X509_VERIFY]=!0,b[h.OPT_PROD_MODE]=!1,b[h.OPT_COMM_CONFIG_CB]=null,j.defaults(a,b),this.options=a}var e,f=c(3),g=f.FutoInError,h=f.Options,i=c(7),j=c(9);if(i){var k=require;e=k("./node_comms")}else e=c(2);b=a.exports=function(b){return new a.exports.SimpleCCMImpl(b)},d.prototype={onRegister:function(a,b){b.funcs={},b.inherits=[],b.constraints={}},createMessage:function(a,b,c){var d=b.info,e={f:d.iface+":"+d.version+":"+b.name,p:c,forcersp:!0};null!==d.creds&&"master"!==d.creds&&(e.sec=d.creds),a.success(e)},onMessageResponse:function(a,b,c){"e"in c?a.error(c.e,c.edesc):a.success(c.r)},onDataResponse:function(a,b,c){a.success(c)},perfomHTTP:function(a,b,c){var d=b.native_iface;"_httpcomms"in d||(d._httpcomms=new e.HTTPComms),d._httpcomms.perform(a,b,c)},perfomWebSocket:function(a,b,c){var d=b.native_iface;"_wscomms"in d||(d._wscomms=new e.WSComms),d._wscomms.perform(a,b,c)},perfomUNIX:function(a,b,c){a.error(g.InvokerError,"Not Implemented")}},b.SimpleCCMImpl=d},function(a){a.exports=!1;try{a.exports="[object process]"===Object.prototype.toString.call(d.process)}catch(b){}},function(b){b.exports=a},function(a){a.exports=b}],c(1)});